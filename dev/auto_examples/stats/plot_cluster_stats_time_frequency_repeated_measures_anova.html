<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Mass-univariate twoway repeated measures ANOVA on single trial power &mdash; MNE 0.9.dev0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/navy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.dev0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="MNE 0.9.dev0 documentation" href="../../index.html" />
    <link rel="up" title="Examples" href="../index.html" />
    <link rel="next" title="Repeated measures ANOVA on source data with spatio-temporal clustering" href="plot_cluster_stats_spatio_temporal_repeated_measures_anova.html" />
    <link rel="prev" title="Permutation t-test on source data with spatio-temporal clustering" href="plot_cluster_stats_spatio_temporal.html" />

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37225609-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>



    <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);
    js.id=id;js.src="http://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>



    <script type="text/javascript">
    (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    </script>


  </head>
  <body>

<div style="background-color: red; color: white; font-weight:bold; text-align: center; padding: 10px; min-width: 910px">
This documentation is for the development version (0.9.dev0) - <a href="http://martinos.org/mne/stable">Stable version</a>
</div>

<div style="background-color: white; text-align: left; padding: 10px 7px 15px 15px; min-width: 910px">
<div style="float: left">
<a href="../../index.html"><img src="../../_static/mne_logo.png" border="0" alt="py4sci"/></a>
</div>

<div style="float: right">
<a href="../../index.html"><img src="../../_static/institutions.png" border="0" alt="py4sci"/></a>
</div>
<br style="clear:both"/>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="right" >
          <a href="plot_cluster_stats_spatio_temporal_repeated_measures_anova.html" title="Repeated measures ANOVA on source data with spatio-temporal clustering"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="plot_cluster_stats_spatio_temporal.html" title="Permutation t-test on source data with spatio-temporal clustering"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Home</a>&nbsp;|&nbsp;</li>
        <li><a href="../../manual.html">Manual</a>&nbsp;|&nbsp;</li>
        <li><a href="../../mne-python.html">Python</a>&nbsp;|&nbsp;</li>
        <li><a href="../../cite.html">Cite MNE</a>&nbsp;|&nbsp;</li>
        <!-- <li><a href="../../search.html">Search</a></li> -->

          <li><a href="../../mne-python.html" >MNE with Python</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Examples</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mne-python.html">MNE with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mne-cpp.html">MNE with CPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">Cite MNE and MNE-Python</a></li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Versions</h3>
<ul class="current">
    <li class="toctree-l1"><a href=http://martinos.org/mne/stable>Stable</a></li>
    <li class="toctree-l1"><a href=http://martinos.org/mne/dev>Development</a></li>
</ul>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mass-univariate-twoway-repeated-measures-anova-on-single-trial-power">
<span id="example-stats-plot-cluster-stats-time-frequency-repeated-measures-anova-py"></span><h1>Mass-univariate twoway repeated measures ANOVA on single trial power<a class="headerlink" href="#mass-univariate-twoway-repeated-measures-anova-on-single-trial-power" title="Permalink to this headline">Â¶</a></h1>
<p>This script shows how to conduct a mass-univariate repeated measures
ANOVA. As the model to be fitted assumes two fully crossed factors,
we will study the interplay between perceptual modality
(auditory VS visual) and the location of stimulus presentation
(left VS right). Here we use single trials as replications
(subjects) while iterating over time slices plus frequency bands
for to fit our mass-univariate model. For the sake of simplicity we
will confine this analysis to one single channel of which we know
that it exposes a strong induced response. We will then visualize
each effect by creating a corresponding mass-univariate effect
image. We conclude with accounting for multiple comparisons by
performing a permutation clustering test using the ANOVA as
clustering function. The results final will be compared to
multiple comparisons using False Discovery Rate correction.</p>
<ul class="horizontal">
<li><a class="first reference internal image-reference" href="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_001.png"><img alt="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_001.png" src="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_001.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_002.png"><img alt="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_002.png" src="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_002.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_003.png"><img alt="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_003.png" src="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_003.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_004.png"><img alt="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_004.png" src="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_004.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_005.png"><img alt="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_005.png" src="../../_images/plot_cluster_stats_time_frequency_repeated_measures_anova_005.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
</ul>
<p><strong>Script output</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1688</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Python source code:</strong> <a class="reference download internal" href="../../_downloads/plot_cluster_stats_time_frequency_repeated_measures_anova.py"><tt class="xref download docutils literal"><span class="pre">plot_cluster_stats_time_frequency_repeated_measures_anova.py</span></tt></a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Authors: Denis Engemann &lt;denis.engemann@gmail.com&gt;</span>
<span class="c">#          Eric Larson &lt;larson.eric.d@gmail.com&gt;</span>
<span class="c">#          Alexandre Gramfort &lt;alexandre.gramfort@telecom-paristech.fr&gt;</span>
<span class="c">#</span>
<span class="c"># License: BSD (3-clause)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">mne.time_frequency</span> <span class="kn">import</span> <a href="../../generated/mne.time_frequency.single_trial_power.html#mne.time_frequency.single_trial_power"><span class="n">single_trial_power</span></a>
<span class="kn">from</span> <span class="nn">mne.stats</span> <span class="kn">import</span> <span class="n">f_threshold_twoway_rm</span><span class="p">,</span> <span class="n">f_twoway_rm</span><span class="p">,</span> <a href="../../generated/mne.stats.fdr_correction.html#mne.stats.fdr_correction"><span class="n">fdr_correction</span></a>
<span class="kn">from</span> <span class="nn">mne.datasets</span> <span class="kn">import</span> <span class="n">sample</span>

<span class="k">print</span><span class="p">(</span><span class="n">__doc__</span><span class="p">)</span>

<span class="c">###############################################################################</span>
<span class="c"># Set parameters</span>
<span class="n">data_path</span> <span class="o">=</span> <a href="../../generated/mne.datasets.sample.data_path.html#mne.datasets.sample.data_path"><span class="n">sample</span><span class="o">.</span><span class="n">data_path</span></a><span class="p">()</span>
<span class="n">raw_fname</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s">&#39;/MEG/sample/sample_audvis_raw.fif&#39;</span>
<span class="n">event_fname</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s">&#39;/MEG/sample/sample_audvis_raw-eve.fif&#39;</span>
<span class="n">event_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span>
<span class="n">tmax</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c"># Setup for reading the raw data</span>
<span class="n">raw</span> <span class="o">=</span> <a href="../../generated/mne.io.Raw.html#mne.io.Raw"><span class="n">io</span><span class="o">.</span><span class="n">Raw</span></a><span class="p">(</span><span class="n">raw_fname</span><span class="p">)</span>
<span class="n">events</span> <span class="o">=</span> <a href="../../generated/mne.read_events.html#mne.read_events"><span class="n">mne</span><span class="o">.</span><span class="n">read_events</span></a><span class="p">(</span><span class="n">event_fname</span><span class="p">)</span>

<span class="n">include</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;bads&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;MEG 2443&#39;</span><span class="p">]</span>  <span class="c"># bads</span>

<span class="c"># picks MEG gradiometers</span>
<span class="n">picks</span> <span class="o">=</span> <a href="../../generated/mne.pick_types.html#mne.pick_types"><span class="n">mne</span><span class="o">.</span><span class="n">pick_types</span></a><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">meg</span><span class="o">=</span><span class="s">&#39;grad&#39;</span><span class="p">,</span> <span class="n">eeg</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">eog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                       <span class="n">stim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="s">&#39;bads&#39;</span><span class="p">)</span>

<span class="n">ch_name</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;ch_names&#39;</span><span class="p">][</span><span class="n">picks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<span class="c"># Load conditions</span>
<span class="n">reject</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="mf">4000e-13</span><span class="p">,</span> <span class="n">eog</span><span class="o">=</span><span class="mf">150e-6</span><span class="p">)</span>
<span class="n">event_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">aud_l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aud_r</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">vis_l</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">vis_r</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">epochs</span> <span class="o">=</span> <a href="../../generated/mne.Epochs.html#mne.Epochs"><span class="n">mne</span><span class="o">.</span><span class="n">Epochs</span></a><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span>
                    <span class="n">picks</span><span class="o">=</span><span class="n">picks</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">reject</span><span class="o">=</span><span class="n">reject</span><span class="p">)</span>

<span class="c"># make sure all conditions have the same counts, as the ANOVA expects a</span>
<span class="c"># fully balanced data matrix and does not forgive imbalances that generously</span>
<span class="c"># (risk of type-I error)</span>
<span class="n">epochs</span><span class="o">.</span><span class="n">equalize_event_counts</span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c"># Time vector</span>
<span class="n">times</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">epochs</span><span class="o">.</span><span class="n">times</span>  <span class="c"># change unit to ms</span>

<span class="c"># Factor to downs-sample the temporal dimension of the PSD computed by</span>
<span class="c"># single_trial_power.</span>
<span class="n">decim</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">frequencies</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.arange.html#numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c"># define frequencies of interest</span>
<span class="n">sfreq</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;sfreq&#39;</span><span class="p">]</span>  <span class="c"># sampling in Hz</span>
<span class="n">n_cycles</span> <span class="o">=</span> <span class="n">frequencies</span> <span class="o">/</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">baseline_mask</span> <span class="o">=</span> <span class="n">times</span><span class="p">[::</span><span class="n">decim</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>

<span class="c"># now create TFR representations for all conditions</span>
<span class="n">epochs_power</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="p">[</span><span class="n">epochs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[:,</span> <span class="mi">97</span><span class="p">:</span><span class="mi">98</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">event_id</span><span class="p">]:</span>
    <span class="n">this_power</span> <span class="o">=</span> <a href="../../generated/mne.time_frequency.single_trial_power.html#mne.time_frequency.single_trial_power"><span class="n">single_trial_power</span></a><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">sfreq</span><span class="o">=</span><span class="n">sfreq</span><span class="p">,</span>
                                    <span class="n">frequencies</span><span class="o">=</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">n_cycles</span><span class="o">=</span><span class="n">n_cycles</span><span class="p">,</span>
                                    <span class="n">decim</span><span class="o">=</span><span class="n">decim</span><span class="p">)</span>
    <span class="n">this_power</span> <span class="o">=</span> <span class="n">this_power</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c"># we only have one channel.</span>
    <span class="c"># Compute ratio with baseline power (be sure to correct time vector with</span>
    <span class="c"># decimation factor)</span>
    <span class="n">epochs_baseline</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.mean.html#numpy.mean"><span class="n">np</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><span class="n">this_power</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">baseline_mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">this_power</span> <span class="o">/=</span> <span class="n">epochs_baseline</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/arrays.indexing.html#numpy.newaxis"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">]</span>
    <span class="n">epochs_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_power</span><span class="p">)</span>

<span class="c">###############################################################################</span>
<span class="c"># Setup repeated measures ANOVA</span>

<span class="n">n_conditions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">epochs</span><span class="o">.</span><span class="n">event_id</span><span class="p">)</span>
<span class="n">n_replications</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_conditions</span>
<span class="c"># we will tell the ANOVA how to interpret the data matrix in terms of</span>
<span class="c"># factors. This done via the factor levels argument which is a list</span>
<span class="c"># of the number factor levels for each factor.</span>
<span class="n">factor_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c"># number of levels in each factor</span>
<span class="n">effects</span> <span class="o">=</span> <span class="s">&#39;A*B&#39;</span>  <span class="c"># this is the default signature for computing all effects</span>
<span class="c"># Other possible options are &#39;A&#39; or &#39;B&#39; for the corresponding main effects</span>
<span class="c"># or &#39;A:B&#39; for the interaction effect only (this notation is borrowed from the</span>
<span class="c"># R formula language)</span>
<span class="n">n_frequencies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
<span class="n">n_times</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">[::</span><span class="n">decim</span><span class="p">])</span>

<span class="c"># Now we&#39;ll assemble the data matrix and swap axes so the trial replications</span>
<span class="c"># are the first dimension and the conditions are the second dimension</span>
<span class="n">data</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.swapaxes.html#numpy.swapaxes"><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span></a><span class="p">(</span><a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.asarray.html#numpy.asarray"><span class="n">np</span><span class="o">.</span><span class="n">asarray</span></a><span class="p">(</span><span class="n">epochs_power</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="c"># reshape last two dimensions in one mass-univariate observation-vector</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_replications</span><span class="p">,</span> <span class="n">n_conditions</span><span class="p">,</span> <span class="n">n_frequencies</span> <span class="o">*</span> <span class="n">n_times</span><span class="p">)</span>

<span class="c"># so we have replications * conditions * observations:</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c"># while the iteration scheme used above for assembling the data matrix</span>
<span class="c"># makes sure the first two dimensions are organized as expected (with A =</span>
<span class="c"># modality and B = location):</span>
<span class="c">#</span>
<span class="c">#           A1B1 A1B2 A2B1 B2B2</span>
<span class="c"># trial 1   1.34 2.53 0.97 1.74</span>
<span class="c"># trial ... .... .... .... ....</span>
<span class="c"># trial 56  2.45 7.90 3.09 4.76</span>
<span class="c">#</span>
<span class="c"># Now we&#39;re ready to run our repeated measures ANOVA.</span>

<span class="n">fvals</span><span class="p">,</span> <span class="n">pvals</span> <span class="o">=</span> <span class="n">f_twoway_rm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">factor_levels</span><span class="p">,</span> <span class="n">effects</span><span class="o">=</span><span class="n">effects</span><span class="p">)</span>

<span class="n">effect_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;modality&#39;</span><span class="p">,</span> <span class="s">&#39;location&#39;</span><span class="p">,</span> <span class="s">&#39;modality by location&#39;</span><span class="p">]</span>

<span class="c"># let&#39;s visualize our effects by computing f-images</span>
<span class="k">for</span> <span class="n">effect</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">effect_label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fvals</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">effect_labels</span><span class="p">):</span>
    <a href="http://matplotlib.org/api/figure_api.html#matplotlib.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">()</span>
    <span class="c"># show naive F-values in gray</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.imshow"><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span></a><span class="p">(</span><span class="n">effect</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">211</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.gray"><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span></a><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
               <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
    <span class="c"># create mask for significant Time-frequency locations</span>
    <span class="n">effect</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.ma.masked_array.all.html#numpy.ma.masked_array"><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span></a><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="p">[</span><span class="n">sig</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mo">05</span><span class="p">])</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.imshow"><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span></a><span class="p">(</span><span class="n">effect</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">211</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
               <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
    <a href="http://matplotlib.org/api/colorbar_api.html#matplotlib.colorbar"><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span></a><span class="p">()</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.xlabel"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span></a><span class="p">(</span><span class="s">&#39;time (ms)&#39;</span><span class="p">)</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.ylabel"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span></a><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.title"><span class="n">plt</span><span class="o">.</span><span class="n">title</span></a><span class="p">(</span><span class="s">r&quot;Time-locked response for &#39;</span><span class="si">%s</span><span class="s">&#39; (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">effect_label</span><span class="p">,</span> <span class="n">ch_name</span><span class="p">))</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>

<span class="c"># Note. As we treat trials as subjects, the test only accounts for</span>
<span class="c"># time locked responses despite the &#39;induced&#39; approach.</span>
<span class="c"># For analysis for induced power at the group level averaged TRFs</span>
<span class="c"># are required.</span>


<span class="c">###############################################################################</span>
<span class="c"># Account for multiple comparisons using FDR versus permutation clustering test</span>

<span class="c"># First we need to slightly modify the ANOVA function to be suitable for</span>
<span class="c"># the clustering procedure. Also want to set some defaults.</span>
<span class="c"># Let&#39;s first override effects to confine the analysis to the interaction</span>
<span class="n">effects</span> <span class="o">=</span> <span class="s">&#39;A:B&#39;</span>


<span class="c"># A stat_fun must deal with a variable number of input arguments.</span>
<span class="k">def</span> <span class="nf">stat_fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="c"># Inside the clustering function each condition will be passed as</span>
    <span class="c"># flattened array, necessitated by the clustering procedure.</span>
    <span class="c"># The ANOVA however expects an input array of dimensions:</span>
    <span class="c"># subjects X conditions X observations (optional).</span>
    <span class="c"># The following expression catches the list input and swaps the first and</span>
    <span class="c"># the second dimension and finally calls the ANOVA function.</span>
    <span class="k">return</span> <span class="n">f_twoway_rm</span><span class="p">(</span><a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.swapaxes.html#numpy.swapaxes"><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span></a><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">factor_levels</span><span class="o">=</span><span class="n">factor_levels</span><span class="p">,</span>
                       <span class="n">effects</span><span class="o">=</span><span class="n">effects</span><span class="p">,</span> <span class="n">return_pvals</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># The ANOVA returns a tuple f-values and p-values, we will pick the former.</span>


<span class="n">pthresh</span> <span class="o">=</span> <span class="mf">0.00001</span>  <span class="c"># set threshold rather high to save some time</span>
<span class="n">f_thresh</span> <span class="o">=</span> <span class="n">f_threshold_twoway_rm</span><span class="p">(</span><span class="n">n_replications</span><span class="p">,</span> <span class="n">factor_levels</span><span class="p">,</span> <span class="n">effects</span><span class="p">,</span>
                                 <span class="n">pthresh</span><span class="p">)</span>
<span class="n">tail</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># f-test, so tail &gt; 0</span>
<span class="n">n_permutations</span> <span class="o">=</span> <span class="mi">256</span>  <span class="c"># Save some time (the test won&#39;t be too sensitive ...)</span>
<span class="n">T_obs</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">cluster_p_values</span><span class="p">,</span> <span class="n">h0</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">permutation_cluster_test</span><span class="p">(</span>
    <span class="n">epochs_power</span><span class="p">,</span> <span class="n">stat_fun</span><span class="o">=</span><span class="n">stat_fun</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">f_thresh</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="n">tail</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_permutations</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="c"># Create new stats image with only significant clusters</span>
<span class="n">good_clusers</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.where.html#numpy.where"><span class="n">np</span><span class="o">.</span><span class="n">where</span></a><span class="p">(</span><span class="n">cluster_p_values</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mo">05</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">T_obs_plot</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.ma.masked_array.all.html#numpy.ma.masked_array"><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span></a><span class="p">(</span><span class="n">T_obs</span><span class="p">,</span>
                                <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.invert.html#numpy.invert"><span class="n">np</span><span class="o">.</span><span class="n">invert</span></a><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.squeeze.html#numpy.squeeze"><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span></a><span class="p">(</span><span class="n">good_clusers</span><span class="p">)]))</span>

<a href="http://matplotlib.org/api/figure_api.html#matplotlib.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">()</span>
<span class="k">for</span> <span class="n">f_image</span><span class="p">,</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">T_obs</span><span class="p">,</span> <span class="n">T_obs_plot</span><span class="p">],</span> <span class="p">[</span><a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.gray"><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span></a><span class="p">,</span> <span class="s">&#39;RdBu_r&#39;</span><span class="p">]):</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.imshow"><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span></a><span class="p">(</span><span class="n">f_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
               <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.xlabel"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span></a><span class="p">(</span><span class="s">&#39;time (ms)&#39;</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.ylabel"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span></a><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.title"><span class="n">plt</span><span class="o">.</span><span class="n">title</span></a><span class="p">(</span><span class="s">&#39;Time-locked response for </span><span class="se">\&#39;</span><span class="s">modality by location</span><span class="se">\&#39;</span><span class="s"> (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span>
          <span class="s">&#39; cluster-level corrected (p &lt;= 0.05)&#39;</span> <span class="o">%</span> <span class="n">ch_name</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>

<span class="c"># now using FDR</span>
<span class="n">mask</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <a href="../../generated/mne.stats.fdr_correction.html#mne.stats.fdr_correction"><span class="n">fdr_correction</span></a><span class="p">(</span><span class="n">pvals</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">T_obs_plot2</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.ma.masked_array.all.html#numpy.ma.masked_array"><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span></a><span class="p">(</span><span class="n">T_obs</span><span class="p">,</span> <a href="http://docs.scipy.org/doc/numpy-1.6.0/reference/generated/numpy.invert.html#numpy.invert"><span class="n">np</span><span class="o">.</span><span class="n">invert</span></a><span class="p">(</span><span class="n">mask</span><span class="p">))</span>

<a href="http://matplotlib.org/api/figure_api.html#matplotlib.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">()</span>
<span class="k">for</span> <span class="n">f_image</span><span class="p">,</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">T_obs</span><span class="p">,</span> <span class="n">T_obs_plot2</span><span class="p">],</span> <span class="p">[</span><a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.gray"><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span></a><span class="p">,</span> <span class="s">&#39;RdBu_r&#39;</span><span class="p">]):</span>
    <a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.imshow"><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span></a><span class="p">(</span><span class="n">f_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
               <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>

<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.xlabel"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span></a><span class="p">(</span><span class="s">&#39;time (ms)&#39;</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.ylabel"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span></a><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.title"><span class="n">plt</span><span class="o">.</span><span class="n">title</span></a><span class="p">(</span><span class="s">&#39;Time-locked response for </span><span class="se">\&#39;</span><span class="s">modality by location</span><span class="se">\&#39;</span><span class="s"> (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span>
          <span class="s">&#39; FDR corrected (p &lt;= 0.05)&#39;</span> <span class="o">%</span> <span class="n">ch_name</span><span class="p">)</span>
<a href="http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>

<span class="c"># Both, cluster level and FDR correction help getting rid of</span>
<span class="c"># putatively spots we saw in the naive f-images.</span>
</pre></div>
</div>
<p><strong>Total running time of the example:</strong>    8 seconds</p>
<div class="social-button-container">
    <div class="social-button">
        <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
    </div>
    <div class="social-button">
        <g:plusone annotation="inline" width="120" size="medium"></g:plusone>
    </div>
    <div class="social-button">
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
            fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <div class="fb-like" data-send="false" data-width="450" data-show-faces="false"></div>
    </div>
</div></div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
        &copy; Copyright 2012-2015, MNE Developers.
      Last updated on May 14, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>