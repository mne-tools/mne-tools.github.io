<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Brainstorm CTF phantom dataset tutorial &#8212; MNE 0.18.dev0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/reset-syntax.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />

    <script type="text/javascript" src="../_static/copybutton.js"></script>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37225609-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>


    <link rel="stylesheet" href="../_static/style.css " type="text/css" />
    <link rel="stylesheet" href="../_static/font-awesome.css" type="text/css" />
    <link rel="stylesheet" href="../_static/flag-icon.css" type="text/css" />



    <script type="text/javascript">
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);
    js.id=id;js.src="https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>



    <script type="text/javascript">
    (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    </script>


  </head><body>

<div class="row devbar alert alert-danger">
This documentation is for <strong>development version 0.18.dev0</strong>.
</div>





  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/mne_logo_small.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b>0.18.dev0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../getting_started.html">Install</a></li>
                <li><a href="../documentation.html">Documentation</a></li>
                <li><a href="../python_reference.html">API</a></li>
                <li><a href="../glossary.html">Glossary</a></li>
                <li><a href="../auto_examples/index.html">Examples</a></li>
                <li><a href="../contributing.html">Contribute</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
<div class="navbar-form navbar-right navbar-btn dropdown btn-group-sm" style="margin-left: 20px; margin-top: 5px; margin-bottom: 5px">
  <button type="button" class="btn btn-danger navbar-btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">
    v0.18.dev0
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
    <li><a href="https://mne-tools.github.io/dev/index.html">Development</a></li>
    <li><a href="https://mne-tools.github.io/stable/index.html">v0.17 (stable)</a></li>
    <li><a href="https://mne-tools.github.io/0.16/index.html">v0.16</a></li>
    <li><a href="https://mne-tools.github.io/0.15/index.html">v0.15</a></li>
    <li><a href="https://mne-tools.github.io/0.14/index.html">v0.14</a></li>
    <li><a href="https://mne-tools.github.io/0.13/index.html">v0.13</a></li>
    <li><a href="https://mne-tools.github.io/0.12/index.html">v0.12</a></li>
    <li><a href="https://mne-tools.github.io/0.11/index.html">v0.11</a></li>
  </ul>
</div>


            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/mne_logo_small.png" alt="Logo"/>
            </a></p><ul>
<li><a class="reference internal" href="#">Brainstorm CTF phantom dataset tutorial</a><ul>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-12 content">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Click <a class="reference internal" href="#sphx-glr-download-auto-tutorials-plot-brainstorm-phantom-ctf-py"><span class="std std-ref">here</span></a> to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="brainstorm-ctf-phantom-dataset-tutorial">
<span id="plot-brainstorm-phantom-ctf"></span><span id="sphx-glr-auto-tutorials-plot-brainstorm-phantom-ctf-py"></span><h1>Brainstorm CTF phantom dataset tutorial<a class="headerlink" href="#brainstorm-ctf-phantom-dataset-tutorial" title="Permalink to this headline">¶</a></h1>
<p>Here we compute the evoked from raw for the Brainstorm CTF phantom
tutorial dataset. For comparison, see <a class="footnote-reference" href="#id2" id="id1">[1]</a> and:</p>
<blockquote>
<div><a class="reference external" href="https://neuroimage.usc.edu/brainstorm/Tutorials/PhantomCtf">https://neuroimage.usc.edu/brainstorm/Tutorials/PhantomCtf</a></div></blockquote>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Tadel F, Baillet S, Mosher JC, Pantazis D, Leahy RM.
Brainstorm: A User-Friendly Application for MEG/EEG Analysis.
Computational Intelligence and Neuroscience, vol. 2011, Article ID
879716, 13 pages, 2011. doi:10.1155/2011/879716</td></tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Authors: Eric Larson &lt;larson.eric.d@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># License: BSD (3-clause)</span>

<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne</span> <span class="k">import</span> <a href="../generated/mne.fit_dipole.html#mne.fit_dipole" title="View documentation for mne.fit_dipole"><span class="n">fit_dipole</span></a>
<span class="kn">from</span> <span class="nn">mne.datasets.brainstorm</span> <span class="k">import</span> <span class="n">bst_phantom_ctf</span>
<span class="kn">from</span> <span class="nn">mne.io</span> <span class="k">import</span> <a href="../generated/mne.io.read_raw_ctf.html#mne.io.read_raw_ctf" title="View documentation for mne.io.read_raw_ctf"><span class="n">read_raw_ctf</span></a>

<span class="nb">print</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<p>The data were collected with a CTF system at 2400 Hz.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">bst_phantom_ctf</span><span class="o">.</span><span class="n">data_path</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Switch to these to use the higher-SNR data:</span>
<span class="c1"># raw_path = op.join(data_path, &#39;phantom_200uA_20150709_01.ds&#39;)</span>
<span class="c1"># dip_freq = 7.</span>
<span class="n">raw_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;phantom_20uA_20150603_03.ds&#39;</span><span class="p">)</span>
<span class="n">dip_freq</span> <span class="o">=</span> <span class="mf">23.</span>
<span class="n">erm_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;emptyroom_20150709_01.ds&#39;</span><span class="p">)</span>
<span class="n">raw</span> <span class="o">=</span> <a href="../generated/mne.io.read_raw_ctf.html#mne.io.read_raw_ctf" title="View documentation for mne.io.read_raw_ctf"><span class="n">read_raw_ctf</span></a><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ds directory : /home/circleci/mne_data/MNE-brainstorm-data/bst_phantom_ctf/phantom_20uA_20150603_03.ds
    res4 data read.
    hc data read.
    Separate EEG position data file read.
    Quaternion matching (desired vs. transformed):
      -0.39   74.35    0.00 mm &lt;-&gt;   -0.39   74.35    0.00 mm (orig :  -39.23   63.82 -204.07 mm) diff =    0.000 mm
       0.39  -74.35    0.00 mm &lt;-&gt;    0.39  -74.35    0.00 mm (orig :   65.69  -41.53 -205.68 mm) diff =    0.000 mm
      75.00    0.00    0.00 mm &lt;-&gt;   75.00   -0.00    0.00 mm (orig :   64.32   61.80 -226.08 mm) diff =    0.000 mm
    Coordinate transformations established.
    Polhemus data for 3 HPI coils added
    Device coordinate locations for 3 HPI coils added
    Measurement info composed.
Finding samples for /home/circleci/mne_data/MNE-brainstorm-data/bst_phantom_ctf/phantom_20uA_20150603_03.ds/phantom_20uA_20150603_03.meg4:
    System clock channel is available, checking which samples are valid.
    10 x 2400 = 24000 samples from 304 chs
Current compensation grade : 3
Reading 0 ... 23999  =      0.000 ...    10.000 secs...
</pre></div>
</div>
<p>The sinusoidal signal is generated on channel HDAC006, so we can use
that to obtain precise timing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sinusoid</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">raw</span><span class="o">.</span><span class="n">ch_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;HDAC006-4408&#39;</span><span class="p">)]</span>
<a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.figure.html#matplotlib.pyplot.figure" title="View documentation for matplotlib.pyplot.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">()</span>
<a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.plot.html#matplotlib.pyplot.plot" title="View documentation for matplotlib.pyplot.plot"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span></a><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">times</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">sinusoid</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">times</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">])</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_brainstorm_phantom_ctf_001.png" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_brainstorm_phantom_ctf_001.png" />
<p>Let’s create some events using this signal by thresholding the sinusoid.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">events</span> <span class="o">=</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.where.html#numpy.where" title="View documentation for numpy.where"><span class="n">np</span><span class="o">.</span><span class="n">where</span></a><span class="p">(</span><a href="https://www.numpy.org/devdocs/reference/generated/numpy.diff.html#numpy.diff" title="View documentation for numpy.diff"><span class="n">np</span><span class="o">.</span><span class="n">diff</span></a><span class="p">(</span><span class="n">sinusoid</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">raw</span><span class="o">.</span><span class="n">first_samp</span>
<span class="n">events</span> <span class="o">=</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.vstack.html#numpy.vstack" title="View documentation for numpy.vstack"><span class="n">np</span><span class="o">.</span><span class="n">vstack</span></a><span class="p">((</span><span class="n">events</span><span class="p">,</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.zeros_like.html#numpy.zeros_like" title="View documentation for numpy.zeros_like"><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span></a><span class="p">(</span><span class="n">events</span><span class="p">),</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.ones_like.html#numpy.ones_like" title="View documentation for numpy.ones_like"><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span></a><span class="p">(</span><span class="n">events</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<p>The CTF software compensation works reasonably well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raw</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_brainstorm_phantom_ctf_002.png" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_brainstorm_phantom_ctf_002.png" />
<p>But here we can get slightly better noise suppression, lower localization
bias, and a better dipole goodness of fit with spatio-temporal (tSSS)
Maxwell filtering:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raw</span><span class="o">.</span><span class="n">apply_gradient_compensation</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># must un-do software compensation first</span>
<span class="n">mf_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">st_duration</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">raw</span> <span class="o">=</span> <a href="../generated/mne.preprocessing.maxwell_filter.html#mne.preprocessing.maxwell_filter" title="View documentation for mne.preprocessing.maxwell_filter"><span class="n">mne</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">maxwell_filter</span></a><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="o">**</span><span class="n">mf_kwargs</span><span class="p">)</span>
<span class="n">raw</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_brainstorm_phantom_ctf_003.png" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_brainstorm_phantom_ctf_003.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Compensator constructed to change 3 -&gt; 0
Applying compensator to loaded data
Maxwell filtering raw data
    Using loaded raw data
    No bad MEG channels
    Processing 0 gradiometers and 299 magnetometers (of which 290 are actually KIT gradiometers)
    Using origin 0.0, 0.0, 0.0 mm in the head frame
    Processing data using tSSS with st_duration=10.0
        Using 86/95 harmonic components for    0.000  (71/80 in, 15/15 out)
    Processing 1 data chunk
        Projecting  8 intersecting tSSS components for    0.000 -   10.000 sec (#1/1)
[done]
</pre></div>
</div>
<p>Our choice of tmin and tmax should capture exactly one cycle, so
we can make the unusual choice of baselining using the entire epoch
when creating our evoked data. We also then crop to a single time point
(&#64;t=0) because this is a peak in our signal.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">dip_freq</span>
<span class="n">tmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">tmin</span>
<span class="n">epochs</span> <span class="o">=</span> <a href="../generated/mne.Epochs.html#mne.Epochs" title="View documentation for mne.Epochs"><span class="n">mne</span><span class="o">.</span><span class="n">Epochs</span></a><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">event_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span>
                    <span class="n">baseline</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
<span class="n">evoked</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
<span class="n">evoked</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_brainstorm_phantom_ctf_004.png" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_brainstorm_phantom_ctf_004.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>460 matching events found
Applying baseline correction (mode: mean)
Not setting metadata
0 projection items activated
</pre></div>
</div>
<p id="plt-brainstorm-phantom-ctf-eeg-sphere-geometry">Let’s use a <a class="reference internal" href="../manual/source_localization/forward.html#ch-forward-spherical-model"><span class="std std-ref">sphere head geometry model</span></a>
and let’s see the coordinate alignment and the sphere location.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sphere</span> <span class="o">=</span> <a href="../generated/mne.make_sphere_model.html#mne.make_sphere_model" title="View documentation for mne.make_sphere_model"><span class="n">mne</span><span class="o">.</span><span class="n">make_sphere_model</span></a><span class="p">(</span><span class="n">r0</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">head_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<a href="../generated/mne.viz.plot_alignment.html#mne.viz.plot_alignment" title="View documentation for mne.viz.plot_alignment"><span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_alignment</span></a><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                       <span class="n">meg</span><span class="o">=</span><span class="s1">&#39;helmet&#39;</span><span class="p">,</span> <span class="n">bem</span><span class="o">=</span><span class="n">sphere</span><span class="p">,</span> <span class="n">dig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">surfaces</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brain&#39;</span><span class="p">])</span>
<span class="k">del</span> <span class="n">raw</span><span class="p">,</span> <span class="n">epochs</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_brainstorm_phantom_ctf_005.png" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_brainstorm_phantom_ctf_005.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Getting helmet for system CTF_275
</pre></div>
</div>
<p>To do a dipole fit, let’s use the covariance provided by the empty room
recording.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raw_erm</span> <span class="o">=</span> <a href="../generated/mne.io.read_raw_ctf.html#mne.io.read_raw_ctf" title="View documentation for mne.io.read_raw_ctf"><span class="n">read_raw_ctf</span></a><span class="p">(</span><span class="n">erm_path</span><span class="p">)</span><span class="o">.</span><span class="n">apply_gradient_compensation</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">raw_erm</span> <span class="o">=</span> <a href="../generated/mne.preprocessing.maxwell_filter.html#mne.preprocessing.maxwell_filter" title="View documentation for mne.preprocessing.maxwell_filter"><span class="n">mne</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">maxwell_filter</span></a><span class="p">(</span><span class="n">raw_erm</span><span class="p">,</span> <span class="n">coord_frame</span><span class="o">=</span><span class="s1">&#39;meg&#39;</span><span class="p">,</span>
                                           <span class="o">**</span><span class="n">mf_kwargs</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <a href="../generated/mne.compute_raw_covariance.html#mne.compute_raw_covariance" title="View documentation for mne.compute_raw_covariance"><span class="n">mne</span><span class="o">.</span><span class="n">compute_raw_covariance</span></a><span class="p">(</span><span class="n">raw_erm</span><span class="p">)</span>
<span class="k">del</span> <span class="n">raw_erm</span>

<span class="n">dip</span><span class="p">,</span> <span class="n">residual</span> <span class="o">=</span> <a href="../generated/mne.fit_dipole.html#mne.fit_dipole" title="View documentation for mne.fit_dipole"><span class="n">fit_dipole</span></a><span class="p">(</span><span class="n">evoked</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ds directory : /home/circleci/mne_data/MNE-brainstorm-data/bst_phantom_ctf/emptyroom_20150709_01.ds
    res4 data read.
    hc data read.
    Separate EEG position data file read.
    Quaternion matching (desired vs. transformed):
      -0.00   74.50    0.00 mm &lt;-&gt;   -0.00   74.50    0.00 mm (orig :  -50.17   57.61 -188.51 mm) diff =    0.000 mm
       0.00  -74.50    0.00 mm &lt;-&gt;    0.00  -74.50   -0.00 mm (orig :   60.49  -42.15 -190.81 mm) diff =    0.000 mm
      74.66    0.00    0.00 mm &lt;-&gt;   74.66   -0.00    0.00 mm (orig :   53.03   61.29 -209.99 mm) diff =    0.000 mm
    Coordinate transformations established.
    Polhemus data for 3 HPI coils added
    Device coordinate locations for 3 HPI coils added
    Measurement info composed.
Finding samples for /home/circleci/mne_data/MNE-brainstorm-data/bst_phantom_ctf/emptyroom_20150709_01.ds/emptyroom_20150709_01.meg4:
    System clock channel is available, checking which samples are valid.
    100 x 600 = 60000 samples from 304 chs
Current compensation grade : 3
Compensator constructed to change 3 -&gt; 0
Maxwell filtering raw data
    Loading raw data from disk
    No bad MEG channels
    Processing 0 gradiometers and 299 magnetometers (of which 290 are actually KIT gradiometers)
    Using origin 0.0, 0.0, 0.0 mm in the meg frame (1.3, -8.8, -2.8 mm in the head frame)
    Processing data using tSSS with st_duration=10.0
        Using 90/95 harmonic components for    0.000  (75/80 in, 15/15 out)
    Processing 10 data chunks
        Projecting  8 intersecting tSSS components for    0.000 -    9.998 sec  (#1/10)
        Projecting  8 intersecting tSSS components for   10.000 -   19.998 sec  (#2/10)
        Projecting  8 intersecting tSSS components for   20.000 -   29.998 sec  (#3/10)
        Projecting  8 intersecting tSSS components for   30.000 -   39.998 sec  (#4/10)
        Projecting  9 intersecting tSSS components for   40.000 -   49.998 sec  (#5/10)
        Projecting  8 intersecting tSSS components for   50.000 -   59.998 sec  (#6/10)
        Projecting  7 intersecting tSSS components for   60.000 -   69.998 sec  (#7/10)
        Projecting  9 intersecting tSSS components for   70.000 -   79.998 sec  (#8/10)
        Projecting  9 intersecting tSSS components for   80.000 -   89.998 sec  (#9/10)
        Projecting  8 intersecting tSSS components for   90.000 -   99.998 sec (#10/10)
[done]
Using up to 499 segments
Number of samples used : 59880
[done]
BEM               : &lt;ConductorModel  |  Sphere (no layers): r0=[0.0, 0.0, 0.0] mm&gt;
MRI transform     : identity
Sphere model      : origin at (   0.00    0.00    0.00) mm, max_rad =    0.1 mm
Guess grid        :   20.0 mm
Guess mindist     :    5.0 mm
Guess exclude     :   20.0 mm
Using standard MEG coil definitions.

Coordinate transformation: MRI (surface RAS) -&gt; head
     1.000000  0.000000  0.000000       0.00 mm
     0.000000  1.000000  0.000000       0.00 mm
     0.000000  0.000000  1.000000       0.00 mm
     0.000000  0.000000  0.000000       1.00
Coordinate transformation: MEG device -&gt; head
     0.999939 -0.002039 -0.010868      -2.00 mm
    -0.001115  0.959234 -0.282612     -20.74 mm
     0.011001  0.282607  0.959173       9.38 mm
     0.000000  0.000000  0.000000       1.00
0 bad channels total
Read 273 MEG channels from info
Read  26 MEG compensation channels from info
84 coil definitions read
Coordinate transformation: MEG device -&gt; head
     0.999939 -0.002039 -0.010868      -2.00 mm
    -0.001115  0.959234 -0.282612     -20.74 mm
     0.011001  0.282607  0.959173       9.38 mm
     0.000000  0.000000  0.000000       1.00
5 compensation data sets in info
MEG coil definitions created in head coordinates.
Decomposing the sensor noise covariance matrix...
Removing 5 compensators from info because not all compensation channels were picked.
Computing data rank from covariance with rank=None
Using tolerance 1.9e-15 (2.2e-16 eps * 273 dim * 0.031 max  singular value)
estimated rank (mag): 75
    MAG: rank 75 computed from 0s data channels with 273 projectors
Setting small MAG eigenvalues to zero.
Not doing PCA for MAG.
    Created the whitener using a noise covariance matrix with rank 75 (198 small eigenvalues omitted)

---- Computing the forward solution for the guesses...
Making a spherical guess space with radius    98.6 mm...
Filtering (grid =     20 mm)...
Surface CM = (   0.0    0.0    0.0) mm
Surface fits inside a sphere with radius   98.6 mm
Surface extent:
    x =  -98.6 ...   98.6 mm
    y =  -98.6 ...   98.6 mm
    z =  -98.6 ...   98.6 mm
Grid extent:
    x = -100.0 ...  100.0 mm
    y = -100.0 ...  100.0 mm
    z = -100.0 ...  100.0 mm
1331 sources before omitting any.
484 sources after omitting infeasible sources.
436 sources remaining after excluding the sources outside the surface and less than    5.0 mm inside.
Go through all guess source locations...
[done 436 sources]
---- Fitted :     0.0 ms
No projector specified for this dataset. Please consider the method self.add_proj.
1 time points fitted
</pre></div>
</div>
<p>Compare the actual position with the estimated one.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expected_pos</span> <span class="o">=</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.array.html#numpy.array" title="View documentation for numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="mf">18.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">49.</span><span class="p">])</span>
<span class="n">diff</span> <span class="o">=</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.sqrt.html#numpy.sqrt" title="View documentation for numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><a href="https://www.numpy.org/devdocs/reference/generated/numpy.sum.html#numpy.sum" title="View documentation for numpy.sum"><span class="n">np</span><span class="o">.</span><span class="n">sum</span></a><span class="p">((</span><span class="n">dip</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">-</span> <span class="n">expected_pos</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Actual pos:     </span><span class="si">%s</span><span class="s1"> mm&#39;</span> <span class="o">%</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.array_str.html#numpy.array_str" title="View documentation for numpy.array_str"><span class="n">np</span><span class="o">.</span><span class="n">array_str</span></a><span class="p">(</span><span class="n">expected_pos</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated pos:  </span><span class="si">%s</span><span class="s1"> mm&#39;</span> <span class="o">%</span> <a href="https://www.numpy.org/devdocs/reference/generated/numpy.array_str.html#numpy.array_str" title="View documentation for numpy.array_str"><span class="n">np</span><span class="o">.</span><span class="n">array_str</span></a><span class="p">(</span><span class="n">dip</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:     </span><span class="si">%0.1f</span><span class="s1"> mm&#39;</span> <span class="o">%</span> <span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Amplitude:      </span><span class="si">%0.1f</span><span class="s1"> nAm&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">1e9</span> <span class="o">*</span> <span class="n">dip</span><span class="o">.</span><span class="n">amplitude</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GOF:            </span><span class="si">%0.1f</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dip</span><span class="o">.</span><span class="n">gof</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Actual pos:     [18.  0. 49.] mm
Estimated pos:  [18.5 -2.2 44.6] mm
Difference:     4.9 mm
Amplitude:      10.0 nAm
GOF:            96.5 %
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  14.025 seconds)</p>
<p><strong>Estimated memory usage:</strong>  446 MB</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorials-plot-brainstorm-phantom-ctf-py">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" download="" href="../_downloads/6f62ed8d0874f258b1e7eee1e1d412ca/plot_brainstorm_phantom_ctf.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_brainstorm_phantom_ctf.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" download="" href="../_downloads/0a164c1d27a634877e2315f71a4fee18/plot_brainstorm_phantom_ctf.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_brainstorm_phantom_ctf.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


    </div>
    
  </div>
</div>
<footer class="footer">
  <div class="container"><img src="../_static/institutions.png" alt="Institutions"></div>
  <div class="container">
    <ul class="list-inline">
      <li><a href="https://github.com/mne-tools/mne-python">GitHub</a></li>
      <li>·</li>
      <li><a href="https://mail.nmr.mgh.harvard.edu/mailman/listinfo/mne_analysis">Mailing list</a></li>
      <li>·</li>
      <li><a href="https://gitter.im/mne-tools/mne-python">Gitter</a></li>
      <li>·</li>
      <li><a href="whats_new.html">What's new</a></li>
      <li>·</li>
      <li><a href="faq.html#cite">Cite MNE</a></li>
      <li class="pull-right"><a href="#">Back to top</a></li>
    </ul>
    <p>&copy; Copyright 2012-2019, MNE Developers. Last updated on 2019-03-19.</p>
  </div>
</footer>
  </body>
</html>